import{I as e}from"./create-data-attribute.js";import{O as t}from"./enableVisualEditing.js";import{VERCEL_STEGA_REGEX as n,vercelStegaDecode as o}from"@vercel/stega";let r;const s=new Uint8Array(16);function i(){if(!r&&(r=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!r))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return r(s)}const a=[];for(let e=0;e<256;++e)a.push((e+256).toString(16).slice(1));var c={randomUUID:typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function l(e,t,n){if(c.randomUUID&&!t&&!e)return c.randomUUID();const o=(e=e||{}).random||(e.rng||i)();if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,t){n=n||0;for(let e=0;e<16;++e)t[n+e]=o[e];return t}return function(e,t=0){return a[e[t+0]]+a[e[t+1]]+a[e[t+2]]+a[e[t+3]]+"-"+a[e[t+4]]+a[e[t+5]]+"-"+a[e[t+6]]+a[e[t+7]]+"-"+a[e[t+8]]+a[e[t+9]]+"-"+a[e[t+10]]+a[e[t+11]]+a[e[t+12]]+a[e[t+13]]+a[e[t+14]]+a[e[t+15]]}(o)}function u(e){const{display:t}=window.getComputedStyle(e);if("inline"!==t)return e;const n=e.parentElement;return n?u(n):null}function d(e,t=!1){return r=e,n.lastIndex=0,n.test(r)?function(e,t=!1){var n;try{const r=o(e);return r&&"sanity.io"===r.origin?(t&&(r.href=null==(n=r.href)?void 0:n.replace(".alt","")),r):null}catch(t){return console.error("Failed to decode stega for string: ",e,"with the original error: ",t),null}}(e,t):null;var r}const m=e=>e.nodeType===Node.ELEMENT_NODE,f=e=>"IMG"===e.tagName,v=e=>"TIME"===e.tagName,p=e=>"SVG"===e.tagName.toUpperCase();function y(e){return"path"in e}function g(e,t){let n=e.split("."),o=t.split(".");const r=Math.min(n.length,o.length);return n=n.slice(0,r).reverse(),o=o.slice(0,r).reverse(),n.reduce(((e,t,n)=>t===o[n]?[...e,t]:[]),[]).reverse().join(".")}function h(e){if(!e.length||!e.map((e=>y(e))).every(((e,t,n)=>e===n[0])))return;if(!y(e[0]))return e[0];const t=e.filter(y);let n=e[0];const o=["projectId","dataset","id","baseUrl","workspace","tool"];for(let e=1;e<t.length;e++){const r=t[e];if(o.some((e=>r[e]!==(null==n?void 0:n[e])))){n=void 0;break}n.path=g(n.path,r.path)}return n}function E(n){var o,r,s;const i=[];function a(t,n){const o=e(n);if(!o)return;const r=u(t);r&&i.push({elements:{element:t,measureElement:r},sanity:o})}if(n)for(const e of n.childNodes){const{nodeType:n,parentElement:c,textContent:l}=e;if(m(e)&&void 0!==(null==(o=e.dataset)?void 0:o.sanityEditTarget)){const t=E(e).map((({sanity:e})=>e));if(!t.map((e=>y(e))).every(((e,t,n)=>e===n[0])))continue;const n=h(t);n&&i.push({elements:{element:e,measureElement:e},sanity:n})}else if(n===Node.TEXT_NODE&&c&&l){const e=d(l);if(!e)continue;a(c,e)}else if(m(e)){if("SCRIPT"===e.tagName||e.id===t)continue;if(null!=(r=e.dataset)&&r.sanity)a(e,e.dataset.sanity);else if(null!=(s=e.dataset)&&s.sanityEditInfo)a(e,e.dataset.sanityEditInfo);else{if(f(e)){const t=d(e.alt,!0);if(!t)continue;a(e,t);continue}if(v(e)){const t=d(e.dateTime,!0);if(!t)continue;a(e,t)}else if(p(e)){if(!e.ariaLabel)continue;const t=d(e.ariaLabel,!0);if(!t)continue;a(e,t)}}i.push(...E(e))}}return i}function w(e){const t=e.getBoundingClientRect();return{x:t.x+scrollX,y:t.y+scrollY,w:t.width,h:t.height}}const b=e=>e instanceof HTMLElement||e instanceof SVGElement;function L({handler:e,overlayElement:t,preventDefault:n}){let o=!1;const r=new Map,s=new WeakMap,i=new Set,a=new WeakMap;let c,u,d,m=[];const f=()=>m[m.length-1];function v(e,t){e.removeEventListener("click",t.click,{capture:!0}),e.removeEventListener("mousemove",t.mousemove,{capture:!0}),e.removeEventListener("mousedown",t.mousedown,{capture:!0}),e.removeEventListener("mouseenter",t.mouseenter),e.removeEventListener("mouseleave",t.mouseleave)}function p({id:t,elements:n,handlers:o,sanity:r}){const{element:s,measureElement:i}=n;(function(e,t){e.addEventListener("click",t.click,{capture:!0}),e.addEventListener("mousemove",t.mousemove,{once:!0,capture:!0}),e.addEventListener("mousedown",t.mousedown,{capture:!0})})(s,o),c.observe(i),e({type:"element/activate",id:t,rect:w(s),sanity:r})}function y({id:t,elements:n,handlers:o}){const{element:r,measureElement:s}=n;v(r,o),c.unobserve(s),m=m.filter((e=>e!==r)),e({type:"element/deactivate",id:t})}function g({elements:o,sanity:d}){const{element:v,measureElement:y}=o,g={click(t){const o=t.target;v===f()&&v.contains(o)&&(n&&(t.preventDefault(),t.stopPropagation()),e({type:"element/click",id:h,sanity:d}))},mousedown(e){e.preventDefault()},mousemove(e){g.mouseenter(e);const t=e.currentTarget;t&&(t.addEventListener("mouseenter",g.mouseenter),t.addEventListener("mouseleave",g.mouseleave))},mouseenter(){document.querySelector("vercel-live-feedback")&&v.closest("[data-vercel-edit-info]")||v.closest("[data-vercel-edit-target]")||(m.push(v),e({type:"element/mouseenter",id:h,rect:w(v)}))},mouseleave(n){function o(){m.pop();const t=f();if(e({type:"element/mouseleave",id:h}),t){const n=s.get(t);n&&e({type:"element/mouseenter",id:n.id,rect:w(t)})}}const{relatedTarget:r}=n;if(b(r)&&t.contains(r)){const e=()=>{o(),r.removeEventListener("mouseleave",e)};r.addEventListener("mouseleave",e)}else o()}},h=l(),E={id:h,elements:o,sanity:d,handlers:g};i.add(v),a.set(y,v),r.set(h,v),s.set(v,E),u.observe(v),c.observe(y),e({type:"element/register",id:h,rect:w(v),sanity:d}),p(E)}function h(e){const t=E(e);for(const e of t)b(e.elements.element)&&!s.has(e.elements.element)&&g(e)}function L(t){const n=s.get(t);if(n){const{id:o,handlers:a}=n;v(t,a),c.unobserve(t),s.delete(t),i.delete(t),r.delete(o),e({type:"element/unregister",id:o})}}function I(e){if(e.filter((e=>{const n=e.target;return n!==t&&!t.contains(n)&&(b(n)&&(s.has(n)&&L(n),h({childNodes:[n]})),!0)})).length)for(const e of i)e.isConnected?k(e):L(e)}function k(t){const n=s.get(t);n&&e({type:"element/updateRect",id:n.id,rect:w(t)})}function U(e){for(const t of e){const e=t.target;if(b(e)){const t=a.get(e);if(!t)return;k(t)}}}function T(e){for(const t of e){const{target:e}=t,n=b(e)&&s.get(e);n&&(t.isIntersecting?p(n):y(n))}}function D(){m=[],e({type:"overlay/blur"})}function N(){for(const e of i)k(e)}function M(e){const{target:t}=e;if(t!==window.document&&b(t))for(const e of i)t.contains(e)&&k(e)}function S(){o||(window.addEventListener("click",D),window.addEventListener("resize",N),window.addEventListener("scroll",M,{capture:!0,passive:!0}),u=new IntersectionObserver(T,{threshold:.3}),c=new ResizeObserver(U),d=new MutationObserver(I),d.observe(document.body,{attributes:!0,characterData:!0,childList:!0,subtree:!0}),h(document.body),o=!0,e({type:"overlay/activate"}))}return window.document.fonts.ready.then((()=>{for(const e of i)k(e)})),S(),{activate:S,deactivate:function(){o&&(window.removeEventListener("click",D),window.removeEventListener("resize",N),window.removeEventListener("scroll",M),u.disconnect(),d.disconnect(),c.disconnect(),i.forEach((e=>{L(e)})),r.clear(),i.clear(),m=[],o=!1,e({type:"overlay/deactivate"}))}}}export{L as c,l as v};//# sourceMappingURL=index.js.map
