"use strict";var e=require("./create-data-attribute.cjs"),t=require("./enableVisualEditing.cjs"),n=require("@vercel/stega");let o;const r=new Uint8Array(16);function s(){if(!o&&(o=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!o))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return o(r)}const i=[];for(let e=0;e<256;++e)i.push((e+256).toString(16).slice(1));var c={randomUUID:typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function a(e,t,n){if(c.randomUUID&&!t&&!e)return c.randomUUID();const o=(e=e||{}).random||(e.rng||s)();if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,t){n=n||0;for(let e=0;e<16;++e)t[n+e]=o[e];return t}return function(e,t=0){return i[e[t+0]]+i[e[t+1]]+i[e[t+2]]+i[e[t+3]]+"-"+i[e[t+4]]+i[e[t+5]]+"-"+i[e[t+6]]+i[e[t+7]]+"-"+i[e[t+8]]+i[e[t+9]]+"-"+i[e[t+10]]+i[e[t+11]]+i[e[t+12]]+i[e[t+13]]+i[e[t+14]]+i[e[t+15]]}(o)}function l(e){const{display:t}=window.getComputedStyle(e);if("inline"!==t)return e;const n=e.parentElement;return n?l(n):null}function u(e,t=!1){return o=e,n.VERCEL_STEGA_REGEX.lastIndex=0,n.VERCEL_STEGA_REGEX.test(o)?function(e,t=!1){var o;try{const r=n.vercelStegaDecode(e);return r&&"sanity.io"===r.origin?(t&&(r.href=null==(o=r.href)?void 0:o.replace(".alt","")),r):null}catch(t){return console.error("Failed to decode stega for string: ",e,"with the original error: ",t),null}}(e,t):null;var o}const d=e=>e.nodeType===Node.ELEMENT_NODE,m=e=>"IMG"===e.tagName,f=e=>"TIME"===e.tagName,v=e=>"SVG"===e.tagName.toUpperCase();function p(e){return"path"in e}function y(e,t){let n=e.split("."),o=t.split(".");const r=Math.min(n.length,o.length);return n=n.slice(0,r).reverse(),o=o.slice(0,r).reverse(),n.reduce(((e,t,n)=>t===o[n]?[...e,t]:[]),[]).reverse().join(".")}function E(e){if(!e.length||!e.map((e=>p(e))).every(((e,t,n)=>e===n[0])))return;if(!p(e[0]))return e[0];const t=e.filter(p);let n=e[0];const o=["projectId","dataset","id","baseUrl","workspace","tool"];for(let e=1;e<t.length;e++){const r=t[e];if(o.some((e=>r[e]!==(null==n?void 0:n[e])))){n=void 0;break}n.path=y(n.path,r.path)}return n}function g(n){var o,r,s;const i=[];function c(t,n){const o=e.I(n);if(!o)return;const r=l(t);r&&i.push({elements:{element:t,measureElement:r},sanity:o})}if(n)for(const e of n.childNodes){const{nodeType:n,parentElement:a,textContent:l}=e;if(d(e)&&void 0!==(null==(o=e.dataset)?void 0:o.sanityEditTarget)){const t=g(e).map((({sanity:e})=>e));if(!t.map((e=>p(e))).every(((e,t,n)=>e===n[0])))continue;const n=E(t);n&&i.push({elements:{element:e,measureElement:e},sanity:n})}else if(n===Node.TEXT_NODE&&a&&l){const e=u(l);if(!e)continue;c(a,e)}else if(d(e)){if("SCRIPT"===e.tagName||e.id===t.O)continue;if(null!=(r=e.dataset)&&r.sanity)c(e,e.dataset.sanity);else if(null!=(s=e.dataset)&&s.sanityEditInfo)c(e,e.dataset.sanityEditInfo);else{if(m(e)){const t=u(e.alt,!0);if(!t)continue;c(e,t);continue}if(f(e)){const t=u(e.dateTime,!0);if(!t)continue;c(e,t)}else if(v(e)){if(!e.ariaLabel)continue;const t=u(e.ariaLabel,!0);if(!t)continue;c(e,t)}}i.push(...g(e))}}return i}function h(e){const t=e.getBoundingClientRect();return{x:t.x+scrollX,y:t.y+scrollY,w:t.width,h:t.height}}const w=e=>e instanceof HTMLElement||e instanceof SVGElement;exports.c=function({handler:e,overlayElement:t,preventDefault:n}){let o=!1;const r=new Map,s=new WeakMap,i=new Set,c=new WeakMap;let l,u,d,m=[];const f=()=>m[m.length-1];function v(e,t){e.removeEventListener("click",t.click,{capture:!0}),e.removeEventListener("mousemove",t.mousemove,{capture:!0}),e.removeEventListener("mousedown",t.mousedown,{capture:!0}),e.removeEventListener("mouseenter",t.mouseenter),e.removeEventListener("mouseleave",t.mouseleave)}function p({id:t,elements:n,handlers:o,sanity:r}){const{element:s,measureElement:i}=n;(function(e,t){e.addEventListener("click",t.click,{capture:!0}),e.addEventListener("mousemove",t.mousemove,{once:!0,capture:!0}),e.addEventListener("mousedown",t.mousedown,{capture:!0})})(s,o),l.observe(i),e({type:"element/activate",id:t,rect:h(s),sanity:r})}function y({id:t,elements:n,handlers:o}){const{element:r,measureElement:s}=n;v(r,o),l.unobserve(s),m=m.filter((e=>e!==r)),e({type:"element/deactivate",id:t})}function E({elements:o,sanity:d}){const{element:v,measureElement:y}=o,E={click(t){const o=t.target;v===f()&&v.contains(o)&&(n&&(t.preventDefault(),t.stopPropagation()),e({type:"element/click",id:g,sanity:d}))},mousedown(e){e.preventDefault()},mousemove(e){E.mouseenter(e);const t=e.currentTarget;t&&(t.addEventListener("mouseenter",E.mouseenter),t.addEventListener("mouseleave",E.mouseleave))},mouseenter(){document.querySelector("vercel-live-feedback")&&v.closest("[data-vercel-edit-info]")||v.closest("[data-vercel-edit-target]")||(m.push(v),e({type:"element/mouseenter",id:g,rect:h(v)}))},mouseleave(n){function o(){m.pop();const t=f();if(e({type:"element/mouseleave",id:g}),t){const n=s.get(t);n&&e({type:"element/mouseenter",id:n.id,rect:h(t)})}}const{relatedTarget:r}=n;if(w(r)&&t.contains(r)){const e=()=>{o(),r.removeEventListener("mouseleave",e)};r.addEventListener("mouseleave",e)}else o()}},g=a(),L={id:g,elements:o,sanity:d,handlers:E};i.add(v),c.set(y,v),r.set(g,v),s.set(v,L),u.observe(v),l.observe(y),e({type:"element/register",id:g,rect:h(v),sanity:d}),p(L)}function L(e){const t=g(e);for(const e of t)w(e.elements.element)&&!s.has(e.elements.element)&&E(e)}function b(t){const n=s.get(t);if(n){const{id:o,handlers:c}=n;v(t,c),l.unobserve(t),s.delete(t),i.delete(t),r.delete(o),e({type:"element/unregister",id:o})}}function I(e){if(e.filter((e=>{const n=e.target;return n!==t&&!t.contains(n)&&(w(n)&&(s.has(n)&&b(n),L({childNodes:[n]})),!0)})).length)for(const e of i)e.isConnected?T(e):b(e)}function T(t){const n=s.get(t);n&&e({type:"element/updateRect",id:n.id,rect:h(t)})}function k(e){for(const t of e){const e=t.target;if(w(e)){const t=c.get(e);if(!t)return;T(t)}}}function U(e){for(const t of e){const{target:e}=t,n=w(e)&&s.get(e);n&&(t.isIntersecting?p(n):y(n))}}function D(){m=[],e({type:"overlay/blur"})}function N(){for(const e of i)T(e)}function R(e){const{target:t}=e;if(t!==window.document&&w(t))for(const e of i)t.contains(e)&&T(e)}function S(){o||(window.addEventListener("click",D),window.addEventListener("resize",N),window.addEventListener("scroll",R,{capture:!0,passive:!0}),u=new IntersectionObserver(U,{threshold:.3}),l=new ResizeObserver(k),d=new MutationObserver(I),d.observe(document.body,{attributes:!0,characterData:!0,childList:!0,subtree:!0}),L(document.body),o=!0,e({type:"overlay/activate"}))}return window.document.fonts.ready.then((()=>{for(const e of i)T(e)})),S(),{activate:S,deactivate:function(){o&&(window.removeEventListener("click",D),window.removeEventListener("resize",N),window.removeEventListener("scroll",R),u.disconnect(),d.disconnect(),l.disconnect(),i.forEach((e=>{b(e)})),r.clear(),i.clear(),m=[],o=!1,e({type:"overlay/deactivate"}))}}},exports.v=a;//# sourceMappingURL=index.cjs.map
