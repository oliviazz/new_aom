{"version":3,"file":"VisualEditing.js","sources":["../../src/visual-editing/VisualEditing.tsx"],"sourcesContent":["'use client'\n\nimport {\n  enableVisualEditing,\n  type HistoryAdapterNavigate,\n  type VisualEditingOptions,\n} from '@sanity/visual-editing'\nimport {usePathname, useRouter, useSearchParams} from 'next/navigation.js'\nimport {useEffect, useRef, useState} from 'react'\n\nimport {revalidateRootLayout} from './actions'\n\n/**\n * @public\n */\nexport interface VisualEditingProps extends Omit<VisualEditingOptions, 'history'> {\n  /**\n   * @deprecated The histoy adapter is already implemented\n   */\n  history?: never\n}\n\nexport default function VisualEditing(props: VisualEditingProps): null {\n  const {refresh, zIndex} = props\n\n  const router = useRouter()\n  const routerRef = useRef(router)\n  const [navigate, setNavigate] = useState<HistoryAdapterNavigate | undefined>()\n\n  useEffect(() => {\n    routerRef.current = router\n  }, [router])\n  useEffect(() => {\n    const disable = enableVisualEditing({\n      zIndex,\n      refresh: refresh\n        ? refresh\n        : (payload) => {\n            switch (payload.source) {\n              case 'manual':\n                return payload.livePreviewEnabled ? manualFastRefresh() : manualFallbackRefresh()\n              case 'mutation':\n                return payload.livePreviewEnabled\n                  ? mutationFastRefresh()\n                  : mutationFallbackRefresh()\n              default:\n                throw new Error('Unknown refresh source', {cause: payload})\n            }\n          },\n      history: {\n        subscribe: (_navigate) => {\n          setNavigate(() => _navigate)\n          return () => setNavigate(undefined)\n        },\n        update: (update) => {\n          switch (update.type) {\n            case 'push':\n              return routerRef.current.push(update.url)\n            case 'pop':\n              return routerRef.current.back()\n            case 'replace':\n              return routerRef.current.replace(update.url)\n            default:\n              throw new Error(`Unknown update type: ${update.type}`)\n          }\n        },\n      },\n    })\n\n    function manualFastRefresh() {\n      // eslint-disable-next-line no-console\n      console.debug(\n        'Live preview is setup, calling router.refresh() to refresh the server components without refetching cached data',\n      )\n      routerRef.current.refresh()\n      return Promise.resolve()\n    }\n    function manualFallbackRefresh() {\n      // eslint-disable-next-line no-console\n      console.debug(\n        'No loaders in live mode detected, or preview kit setup, revalidating root layout',\n      )\n      return revalidateRootLayout()\n    }\n    function mutationFastRefresh(): false {\n      // eslint-disable-next-line no-console\n      console.debug(\n        'Live preview is setup, mutation is skipped assuming its handled by the live preview',\n      )\n      return false\n    }\n    function mutationFallbackRefresh() {\n      // eslint-disable-next-line no-console\n      console.debug(\n        'No loaders in live mode detected, or preview kit setup, revalidating root layout',\n      )\n      return revalidateRootLayout()\n    }\n\n    return () => disable()\n  }, [refresh, zIndex])\n\n  const pathname = usePathname()\n  const searchParams = useSearchParams()\n  useEffect(() => {\n    if (navigate) {\n      navigate({\n        type: 'push',\n        url: `${pathname}${searchParams?.size ? `?${searchParams}` : ''}`,\n      })\n    }\n  }, [navigate, pathname, searchParams])\n\n  return null\n}\n"],"names":["VisualEditing","props","refresh","zIndex","router","useRouter","routerRef","useRef","navigate","setNavigate","useState","useEffect","current","disable","enableVisualEditing","payload","source","livePreviewEnabled","console","debug","Promise","resolve","revalidateRootLayout","Error","cause","history","subscribe","_navigate","update","type","push","url","back","replace","pathname","usePathname","searchParams","useSearchParams","size"],"mappings":"+QAsBA,SAAwBA,EAAcC,GACpC,MAAMC,QAACA,EAASC,OAAAA,GAAUF,EAEpBG,EAASC,IACTC,EAAYC,EAAOH,IAClBI,EAAUC,GAAeC,IAEhCC,GAAU,KACRL,EAAUM,QAAUR,CAAA,GACnB,CAACA,IACJO,GAAU,KACR,MAAME,EAAUC,EAAoB,CAClCX,SACAD,QAASA,GAEL,CAACa,IACC,OAAQA,EAAQC,QACd,IAAK,SACH,OAAOD,EAAQE,oBA+BjBC,QAAAC,MACN,mHAEFb,EAAUM,QAAQV,UACXkB,QAAQC,YAIPH,QAAAC,MACN,oFAEKG,KAzCC,IAAK,WACH,OAAOP,EAAQE,oBA4CjBC,QAAAC,MACN,wFAEK,IAICD,QAAAC,MACN,oFAEKG,KAnDC,QACE,MAAM,IAAIC,MAAM,yBAA0B,CAACC,MAAOT,IACtD,GAENU,QAAS,CACPC,UAAYC,IACVlB,GAAY,IAAMkB,IACX,IAAMlB,OAAY,IAE3BmB,OAASA,IACP,OAAQA,EAAOC,MACb,IAAK,OACH,OAAOvB,EAAUM,QAAQkB,KAAKF,EAAOG,KACvC,IAAK,MACI,OAAAzB,EAAUM,QAAQoB,OAC3B,IAAK,UACH,OAAO1B,EAAUM,QAAQqB,QAAQL,EAAOG,KAC1C,QACE,MAAM,IAAIR,MAAM,wBAAwBK,EAAOC,QACnD,KAmCN,MAAO,IAAMhB,GAAQ,GACpB,CAACX,EAASC,IAEb,MAAM+B,EAAWC,IACXC,EAAeC,IACrB,OAAA1B,GAAU,KACJH,GACFA,EAAS,CACPqB,KAAM,OACNE,IAAK,GAAGG,UAAWE,KAAcE,KAAO,IAAIF,IAAiB,MAC9D,GAEF,CAAC5B,EAAU0B,EAAUE,IAEjB,IACT"}