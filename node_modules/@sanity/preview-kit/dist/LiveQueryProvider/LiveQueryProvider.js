import{jsxs as e,jsx as t,Fragment as r}from"react/jsx-runtime";import{applySourceDocuments as n}from"@sanity/client/csm";import{useRevalidate as s,useDocumentsInUse as o}from"@sanity/preview-kit-compat";import{vercelStegaSplit as c}from"@vercel/stega";import{LRUCache as i}from"lru-cache";import{applyPatch as a}from"mendoza";import{memo as u,useState as l,useEffect as d,useCallback as f,startTransition as p,useMemo as m}from"react";import{defineStoreContext as h}from"../context.js";const g=new i({max:500}),y=u((function(r){const{children:n,refreshInterval:s=1e4,token:o}=r;if(!r.client)throw new Error("Missing a `client` prop with a configured Sanity client instance");const[c]=l((()=>{const{requestTagPrefix:e,resultSourceMap:t}=r.client.config();return r.client.withConfig({requestTagPrefix:e||"sanity.preview-kit",resultSourceMap:"withKeyArraySelector"!==t||"withKeyArraySelector",...o&&{token:o,useCdn:!1,perspective:"previewDrafts",ignoreBrowserTokenWarning:!0}})})),[i]=l((()=>r.logger));d((()=>{i&&i.log(`[@sanity/preview-kit]: With the current configuration you can expect that: Updates that can be traced using Content Source Maps will be applied in real-time. Other updates will be applied every ${s}ms.`)}),[i,s]);const[a,u]=l([]),[g]=l((()=>new Map)),y=function(e){const[t]=l((()=>new Map)),r=f(((r,n,s,o)=>{t.has(r)||(t.set(r,{query:n,params:s,listeners:new Set}),p((()=>e((e=>e.includes(r)?e:[...e,r])))));const c=t.get(r);if(!c||!c.listeners)throw new TypeError("Inconsistent cache for key: "+r);const{listeners:i}=c;return i.add(o),()=>{i.delete(o),0===i.size&&(t.delete(r),p((()=>e((e=>e.includes(r)?e.filter((e=>e!==r)):e)))))}}),[t,e]);return m((()=>({cache:t,subscribe:r})),[t,r])}(u),[w]=l((()=>function(e,t,r){const n=j(t,r);return g.has(n)||g.set(n,{result:e,resultSourceMap:{}}),{subscribe:e=>{const s=y.subscribe(n,t,r,e);return()=>s()},getSnapshot:()=>{var e;return null==(e=g.get(n))?void 0:e.result}}})),[b,I]=l([]),[M]=l((()=>new Map)),N=f((e=>{var t;const r=new Set;if(M.clear(),null!=(t=e.documents)&&t.length)for(const t of e.documents)r.add(t._id),M.set(t._id,t);p((()=>I((e=>{const t=Array.from(new Set([...e,...r]));return JSON.stringify(t.sort())===JSON.stringify(e.sort())?e:t}))))}),[M]);return e(h.Provider,{value:w,children:[n,t(S,{cache:y.cache,client:c,setTurboIds:I,snapshots:g,turboIds:b,docsInUse:M}),a.map((e=>{if(!y.cache.has(e))return null;const{query:r,params:n,listeners:o}=y.cache.get(e);return t(v,{client:c,listeners:o,params:n,query:r,refreshInterval:s,snapshots:g,turboIdsFromSourceMap:N},e)}))]})}));y.displayName="LiveStoreProvider";const v=u((function(e){const{client:t,refreshInterval:r,query:n,params:o,listeners:c,snapshots:i,turboIdsFromSourceMap:a}=e,{projectId:u,dataset:f}=m((()=>{const{projectId:e,dataset:r}=t.config();return{projectId:e,dataset:r}}),[t]),[p,h]=l(null);if(p)throw p;const[g,y]=s({refreshInterval:r}),v="refresh"===g||"inflight"===g;return d((()=>{if(!v)return;let e=!1;const r=new AbortController;const s=y();return async function(){const{signal:s}=r,{result:l,resultSourceMap:d}=await t.fetch(n,o,{signal:s,filterResponse:!1});if(!s.aborted){i.set(j(n,o),{result:M(u,f,l,d),resultSourceMap:null!=d?d:{}}),d&&a(d);for(const e of c.values())e();e=!0}}().catch((e=>{"AbortError"!==e.name&&h(e)})).finally(s),()=>{e||r.abort()}}),[t,f,c,o,u,n,v,i,y,a]),null}));function w(e,t,r){return`${e}-${t}-${r}`}v.displayName="QuerySubscription";const S=u((function(e){const{client:n,snapshots:s,cache:c,turboIds:i,setTurboIds:u,docsInUse:f}=e,{projectId:h,dataset:y}=m((()=>{const{projectId:e,dataset:t}=n.config();return{projectId:e,dataset:t}}),[n]);d((()=>{var e,t;const r=new Set;f.clear();for(const{query:n,params:o}of c.values()){const c=j(n,o),i=s.get(c);if(i&&null!=(t=null==(e=i.resultSourceMap)?void 0:e.documents)&&t.length)for(const e of i.resultSourceMap.documents)r.add(e._id),f.set(e._id,e)}const n=[...r].sort();JSON.stringify(i)!==JSON.stringify(n)&&p((()=>u(n)))}),[c,u,s,i,f]),o(f,h,y);const[v,S]=l([]);d((()=>{const e=new Set(v.flat()),t=new Set;for(const r of i)!e.has(r)&&!g.has(w(h,y,r))&&t.add(r);const r=[...t].slice(0,100);0!==r.length&&p((()=>S((e=>[...e.slice(-100),r]))))}),[v,y,h,i]);const[I,N]=l();return d((()=>{const e=n.listen("*",{},{events:["mutation"],effectFormat:"mendoza",includePreviousRevision:!1,includeResult:!1,tag:"turbo"}).subscribe((e=>{var t,r;if("mutation"!==e.type||null==(r=null==(t=e.effects)?void 0:t.apply)||!r.length)return;const n=w(h,y,e.documentId),s=g.peek(n);if(s){const t={...s};delete t._rev;const r=a(t,e.effects.apply);g.set(n,r)}p((()=>N(e.documentId)))}));return()=>e.unsubscribe()}),[n,y,h]),d((()=>{var e,t,r;if(!I||!i.includes(I))return;const n=[];for(const[r,o]of s.entries())null!=(t=null==(e=o.resultSourceMap)?void 0:e.documents)&&t.length&&(o.result=M(h,y,o.result,o.resultSourceMap),n.push(r));for(const e of n){const t=null==(r=c.get(e))?void 0:r.listeners;if(t)for(const e of t)e()}p((()=>N(void 0)))}),[c,y,I,h,s,i]),t(r,{children:v.map((e=>t(b,{client:n,projectId:h,dataset:y,ids:e},JSON.stringify(e))))})}));S.displayName="Turbo";const b=u((function(e){const{client:t,projectId:r,dataset:n,ids:s}=e;return d((()=>{const e=s.filter((e=>!g.has(w(r,n,e))));0!==e.length&&t.getDocuments(e).then((e=>{for(const t of e)t&&null!=t&&t._id&&g.set(w(r,n,t._id),t)}),console.error)}),[t,n,s,r]),null}));b.displayName="GetDocuments";let I=!1;function M(e,t,r,s){return s?n(r,s,(r=>{if(!r._projectId)return g.get(w(e,t,r._id));I||(console.warn("Cross dataset references are not supported yet, ignoring source document",r),I=!0)}),((e,{previousValue:t})=>{if("string"==typeof e&&"string"==typeof t){const{encoded:r}=c(t),{cleaned:n}=c(e);return`${r}${n}`}return e}),"previewDrafts"):r}function j(e,t){return`${e}-${JSON.stringify(t)}`}export{y as default};//# sourceMappingURL=LiveQueryProvider.js.map
