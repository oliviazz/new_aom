"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("react");let n;const t=new Uint8Array(16);function o(){if(!n&&(n=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!n))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return n(t)}const i=[];for(let e=0;e<256;++e)i.push((e+256).toString(16).slice(1));var r={randomUUID:typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function s(e,n,t){if(r.randomUUID&&!n&&!e)return r.randomUUID();const s=(e=e||{}).random||(e.rng||o)();if(s[6]=15&s[6]|64,s[8]=63&s[8]|128,n){t=t||0;for(let e=0;e<16;++e)n[t+e]=s[e];return n}return function(e,n=0){return i[e[n+0]]+i[e[n+1]]+i[e[n+2]]+i[e[n+3]]+"-"+i[e[n+4]]+i[e[n+5]]+"-"+i[e[n+6]]+i[e[n+7]]+"-"+i[e[n+8]]+i[e[n+9]]+"-"+i[e[n+10]]+i[e[n+11]]+i[e[n+12]]+i[e[n+13]]+i[e[n+14]]+i[e[n+15]]}(s)}const c=["channel/disconnect","channel/response","channel/heartbeat"],a=["handshake/syn","handshake/syn-ack","handshake/ack"],d=e=>c.some((n=>n===e)),u=e=>a.some((n=>n===e)),f=({data:e={}})=>"object"==typeof e&&null!==e&&!Array.isArray(e)&&!("domain"in e)&&["id","type","from","to"].every((n=>n in e))&&e.type.startsWith("handshake/");function l(e){const n=window.self!==window.top||window.opener,t={buffer:[],id:null,origin:null,source:null,status:"connecting"};function o(n,o){if(u(n)||d(n)||"connecting"!==t.status&&"reconnecting"!==t.status){if(t.id&&t.origin&&t.source){const i={connectionId:t.id,data:o,domain:"sanity/channels",from:e.id,id:s(),to:e.connectTo,type:n};try{t.source.postMessage(i,{targetOrigin:t.origin})}catch{throw new Error(`Failed to postMessage '${i.id}' on '${e.id}'`)}}}else t.buffer.push({type:n,data:o})}function i(n){if(f(n))console.error("Visual editing package mismatch detected! Please ensure you are using the latest version of Sanity Studio and any packages listed here:\nhttps://github.com/sanity-io/visual-editing");else if(function(n){const{data:t}=n;return"sanity/channels"===t.domain&&t.to===e.id&&t.from===e.connectTo&&"channel/response"!==t.type}(n)){const{data:e}=n;if(t.origin&&n.origin!==t.origin)return;if(n.source&&t.source!==n.source&&(t.source=n.source),u(e.type)&&e.data){if("handshake/syn"===e.type)return t.origin=n.origin,t.id=e.data.id,a("connecting"),void o("handshake/syn-ack",{id:t.id});if("handshake/ack"===e.type&&e.data.id===t.id)return void a("connected")}else if(e.connectionId===t.id&&n.origin===t.origin){if("channel/disconnect"===e.type)return void a("disconnected");{const n=[e.type,e.data];r.forEach((e=>{e(...n)})),o("channel/response",{responseTo:e.id})}return}}}const r=new Set;const c=new Set;function a(e){t.status=e,c.forEach((n=>{n(e)})),"connected"===e&&function(){const e=[...t.buffer];t.buffer.splice(0,t.buffer.length),e.forEach((({type:e,data:n})=>{o(e,n)}))}()}return window.addEventListener("message",i,!1),a("connecting"),{destroy:function(){["disconnected"].includes(t.status)||a("disconnected"),r.clear(),c.clear(),window.removeEventListener("message",i,!1)},inFrame:n,send:function(e,n){o(e,n)},subscribe:function(e){return r.add(e),()=>r.delete(e)},onStatusUpdate:function(e){return c.add(e),()=>c.delete(e)}}}function p(e){return document.addEventListener("visibilitychange",e),()=>document.removeEventListener("visibilitychange",e)}exports.useDocumentsInUse=function(n,t,o){const[i,r]=e.useState(),[s,c]=e.useState(!1);e.useEffect((()=>{if(window.self===window.top&&!window.opener)return;const e=l({id:"preview-kit",connectTo:"presentation"});e.onStatusUpdate((e=>{"connected"===e?c(!0):"disconnected"===e&&c(!1)}));const n=setTimeout((()=>r(e)),0);return()=>{clearTimeout(n),e.destroy(),r(void 0)}}),[o,t]);const a=JSON.stringify(Array.from(n.keys()));e.useEffect((()=>{"[]"!==a&&i&&s&&i.send("preview-kit/documents",{projectId:t,dataset:o,perspective:"previewDrafts",documents:Array.from(n.values())})}),[a,i,s,o,n,t])},exports.useQueryParams=function(n){const t=e.useMemo((()=>JSON.stringify(n||{})),[n]);return e.useMemo((()=>JSON.parse(t)),[t])},exports.useRevalidate=function(n){const{refreshInterval:t}=n,o=function(){const[n,t]=e.useState(!1);e.useEffect((()=>{t(navigator.onLine);const e=()=>t(!0),n=()=>t(!1);return window.addEventListener("online",e),window.addEventListener("offline",n),()=>{window.removeEventListener("online",e),window.removeEventListener("offline",n)}}),[]);const o=e.useSyncExternalStore(p,(()=>document.visibilityState),(()=>"hidden"));return!n||"hidden"===o}(),[i,r]=e.useState("hit"),s=e.useCallback((()=>(r("inflight"),()=>r("hit"))),[]);return e.useEffect((()=>{if(!t||"hit"!==i)return;const e=setTimeout((()=>r("stale")),t);return()=>clearTimeout(e)}),[t,i]),e.useEffect((()=>{if("hit"!==i)return;const e=()=>r("stale");return window.addEventListener("focus",e),()=>window.removeEventListener("focus",e)}),[t,i]),e.useEffect((()=>{o&&"hit"===i&&r("stale"),!o&&"stale"===i&&r("refresh")}),[o,i]),[i,s]};//# sourceMappingURL=index.cjs.map
